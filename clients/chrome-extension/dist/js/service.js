!function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=3)}([,,,function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(4),a=r(i),u=n(5),c=r(u),d=function(){function e(){var t=this;o(this,e),this.access_token=null,this.UpdateSettings=this.UpdateSettings.bind(this),this._Send_XHR=this._Send_XHR.bind(this),this.ForwardMessage=this.ForwardMessage.bind(this),this._API=this._API.bind(this),chrome.storage.managed.get(null,function(e){t.settings=e})}return s(e,[{key:"UpdateSettings",value:function(e,t){if("managed"===t)for(var n in e)this.settings[n]=e[n]}},{key:"SendReport",value:function(e){var t=this,n=e.reported_by,r=e.message_id,o=function(e){t.settings.server&&t.SendToDashboard(n,e),t.settings.forwardAddress&&t.ForwardMessage(n,e,r),t.settings.deleteOnReport&&t.TrashMessage(r)};this.GetMessage(r,o)}},{key:"SendToDashboard",value:function(e,t){var n={reported_by:e,report:t};this._Send_XHR("POST",this.settings.server||"http://localhost:8080/report/",n,{"Content-Type":"application/json;charset=UTF-8"},null)}},{key:"ForwardMessage",value:function(e,t,n){var r=a.default.toMimeObj(t),o=c.default.encode(t),s={to:this.settings.forwardAddress,from:e,body:chrome.i18n.getMessage("forwardReportBody"),subject:chrome.i18n.getMessage("forwardReportSubject")+r.subject,attaches:[{type:"text/plain",name:n+".txt",base64:o}]},i=a.default.toMimeTxt(s),u={raw:btoa(i).replace(/\//g,"_").replace(/\+/g,"-")};this._API("POST","messages/send",u,function(e,t,n){})}},{key:"TrashMessage",value:function(e){this._API("POST","messages/"+e+"/trash",null,function(e,t,n){})}},{key:"GetMessage",value:function(e,t){this._API("GET","messages/"+e+"?format=raw",null,function(e,n,r){if(!e){var o=JSON.parse(r);if("raw"in o){var s=atob(o.raw.replace(/_/g,"/").replace(/-/g,"+"));t(s)}}})}},{key:"_Send_XHR",value:function(e,t,n,r,o){function s(){o&&o(null,this.status,this.response)}var i=new XMLHttpRequest;i.open(e,t);for(var a in r)r.hasOwnProperty(a)&&i.setRequestHeader(a,r[a]);i.onload=s,i.send(JSON.stringify(n))}},{key:"_API",value:function(e,t,n,r){var o=this,s=null,i=!0,a=function r(){chrome.identity.getAuthToken({interactive:!0},function(a){if(chrome.runtime.lastError)return i&&"Authorization page could not be loaded."==chrome.runtime.lastError.message?(console.log("Retrying due to identity api bug."),i=!1,void r()):(console.log("Received persistent error: "),void console.log(chrome.runtime.lastError));s=a,o._Send_XHR(e,"https://www.googleapis.com/gmail/v1/users/me/"+t,n,{Authorization:"Bearer "+s,"Content-Type":"application/json; charset=UTF-8"},u)})},u=function(e,t,n){if(401==t&&i)return i=!1,void chrome.identity.removeCachedAuthToken({token:s},a);r(e,t,n)};a()}}]),e}(),l=new d;chrome.storage.onChanged.addListener(l.UpdateSettings),chrome.runtime.onMessage.addListener(function(e){l.SendReport(e)})},function(e,t){e.exports=Mime},function(e,t){e.exports=Base64}]);