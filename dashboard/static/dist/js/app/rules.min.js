"use strict";var $api=new API,action_cache=[],load_action=function(e){var t={};return $.each(action_cache,function(n,o){if(o.action_id===e)return t=o,!1}),t},resetModal=function(){$("#name").val(""),$("#rule_conditions").empty(),$("#rule_actions").empty()},addCondition=function(e){var t=$(templates.rule_condition(e));$("#rule_conditions").append(t),$("#rule_conditions select").select2({width:"100%",dropdownParent:$("#rule_modal")}),$(".condition-select2").select2({width:"100%",dropdownParent:$("#rule_modal"),templateSelection:function(e){return e.id?$("<span>"+$(e.element).attr("data-label")+"</span>"):e.text}});var n=$("[name='attribute']").last(),o=$("[name='matches']").last();if(n.on("change",function(){var e=$(this).parent().siblings(".rule_condition_options");e.empty(),e.append($(templates.rule_condition_options($(this).val(),{})))}),n.trigger("change"),!_.isEmpty(e)){n.val(e.attribute).trigger("change");var a=n.parent().siblings(".rule_condition_options");a.find("[name='key']").val(e.key),a.find("[name='value']").val(e.value),o.val(e.matches).trigger("change")}},loadActionOptions=function(e,t){var n=load_action(e.val()),o=e.parent().siblings(".action-options");o.empty(),$.each(n.options,function(e,n){if(n.choices){var a=$(templates.rule_option_choice(e,n.choices));o.append(a),a.select2({width:"100%",dropdownParent:$("#rule_modal")}),_.isEmpty(t)||a.val(t[e]).trigger("change")}else console.log("No options.")})},addAction=function(e){$("#rule_actions").append(templates.rule_action(e,action_cache)),$("#rule_actions select").select2({width:"100%",dropdownParent:$("#rule_modal")});var t=$("[name='actionName']").last();t.on("change",function(){loadActionOptions($(this),{})}),t.trigger("change"),_.isEmpty(e)||(t.val(e.action).trigger("change"),loadActionOptions(t,e.options))},edit=function(e){var t=function(){resetModal(),$("#rule_modal").modal("show"),-1!=e?$api.get_rule(e).success(function(e){$("#name").val(e.name),$("#rule_conditions").empty(),$("#rule_actions").empty(),$("[name='active']").prop("checked",!1),$.each(e.conditions,function(e,t){addCondition(t)}),$.each(e.actions,function(e,t){addAction(t)}),e.active&&$("[name='active']").prop("checked",!0)}):($("[name='active']").prop("checked",!0),$("#rule_conditions").children().length||addCondition({}),$("#rule_actions").children().length||addAction({}))};$("#rule_form").off("submit"),$("#rule_form").on("submit",function(t){t.preventDefault(),save(e)}),action_cache.length?t():$api.get_actions().success(function(e){action_cache=e,t()})},save=function(e){var t={name:$("#name").val(),conditions:[],actions:[],active:!1};$("[name='active']")[0].checked&&(t.active=!0),$("#rule_conditions .form-group").each(function(e,n){t.conditions.push({attribute:$(n).find("[name='attribute']").val(),matches:$(n).find("[name='matches']").val(),key:$(n).find("[name='key']").val(),body:$(n).find("[name='value']").val()})}),$("#rule_actions .form-group").each(function(e,n){var o={action:$(n).find("[name='actionName']").val(),options:{}};$(n).find(".action-options input").each(function(e,t){var n=$(t).attr("name"),a=$(t).val();o.options[n]=a}),$(n).find(".action-options select").each(function(e,t){var n=$(t).attr("name"),a=$(t).val();o.options[n]=a}),t.actions.push(o)});var n="/rules",o="The rule was created successfully";-1!=e&&(n=n+"/"+e.toString(),o="The rule was updated successfully"),$.ajax({url:n,method:"POST",data:JSON.stringify(t),dataType:"json",contentType:"application/json"}).success(function(e){new PNotify({title:"Rule Created",text:o,type:"success",styling:"bootstrap3"}),$("#modal_flash").hide(),$("#rule_modal").modal("hide")})},deleteRule=function(e){swal({title:"Are you sure?",text:"You won't be able to undo this.",type:"warning",showCancelButton:!0,confirmButtonText:"Delete",confirmButtonColor:"#d9534f",reverseButtons:!0,showLoaderOnConfirm:!0,allowOutsideClick:!1,preConfirm:function(){return new Promise(function(t,n){$api.delete_rule(e).success(function(e){t()}).error(function(e){n(e.responseJSON.error)})})}}).then(function(){new PNotify({title:"Rule Deleted",text:"The rule was deleted successfully.",type:"success",styling:"bootstrap3"})})};$(document).ready(function(){$("#new_rule_btn").click(function(){edit(-1)}),$("#add_condition").click(function(){addCondition({})}),$("#add_action").click(function(){addAction({})}),$("#rule_form").on("click",".remove-btn",function(){$(this).closest(".form-group").remove()}),$("#rules-datatable").DataTable({order:[[1,"desc"]],columnDefs:[{render:function(e,t,n){return moment.utc(e).local().format("MMMM Do YYYY, h:mm:ss a")},targets:2}]})});